% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
% ====================
% = Layout & Spacing =
% ====================

\documentclass[
  letterpaper,
  11pt,
  DIV=9,
  openright]{scrbook}

\usepackage{scrlayer-scrpage}
\usepackage{needspace}
\usepackage{ccicons}
\usepackage{fontawesome5}
\usepackage{marginnote}
\usepackage{sidenotes}
\usepackage{booktabs}
\usepackage{pdfpages}
%\usepackage[defaultlines=2,all]{nowidow}
%\usepackage{ragged2e}

\raggedbottom
\setlength{\emergencystretch}{3em} % prevent overfull lines

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

% =============
% = Longtable =
% =============

\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}

% ===========
% = Figures =
% ===========

% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother

% ==================
% = Colors & Fonts =
% ==================

\usepackage{xcolor}
\definecolor{OffBlack}{HTML}{191919}
\definecolor{Maroon}{HTML}{800000}
\definecolor{HopkinsBlue}{HTML}{002D72}
\definecolor{RacingGreen}{HTML}{004225}

\usepackage{fontspec}
%\setmainfont{Literata}[Mapping=tex-text]
%\setsansfont{Adelle Sans}[Mapping=tex-text]
\setmainfont{Literata-Light.ttf}[
	Path           = fonts/ ,
    BoldFont       = Literata-Regular.ttf ,
    ItalicFont     = Literata-LightItalic.ttf ,
    BoldItalicFont = Literata-Italic.ttf ]
\setsansfont{adelle-sans-light.otf}[
	Path           = fonts/ ,
    BoldFont       = adelle-sans-semibold.otf ,
    ItalicFont     = adelle-sans-light-italic.otf ,
    BoldItalicFont = adelle-sans-italic.otf ]
\setmonofont[Scale=0.90]{LFT Etica Mono}

% font style & text alignment for margin notes
\renewcommand{\marginfont}{\color{RacingGreen}\sffamily\scriptsize}
\renewcommand*{\raggedleftmarginnote}{\raggedright}

% smaller sizes for footnotes & captions
\renewcommand{\footnotesize}{\scriptsize}
\renewcommand{\captionsize}{\small}

% smaller font size, more space between rows, for tables 
\newcommand{\tablefont}{\footnotesize} 
\AtBeginEnvironment{tabular}{\tablefont}
\AtBeginEnvironment{tabular*}{\tablefont} 
\AtBeginEnvironment{longtable}{\tablefont}
\AtBeginEnvironment{longtable*}{\tablefont} 
\renewcommand{\arraystretch}{2}

% =========
% = Lists =
% =========
% custom unordered list environment for statutes and other legal code
\usepackage{enumitem}
\newenvironment{legalcode}{%
  \setlist[itemize]{
    label={},
    itemindent=0em,
    leftmargin=1em,
	itemsep=1em,
	parsep=1em,
  }
  \renewcommand{\labelitemi}{}}

\providecommand{\tightlist}{%
  \setlength{\topsep}{0em}\setlength{\partopsep}{1em}\setlength{\itemsep}{1em}\setlength{\parskip}{1em}}

% ============
% = Headings =
% ============

\usepackage{titlesec}

%=== Chapter & Section Headings ===
\titlespacing*{\chapter}{0em}{50mm}{0mm}
\titlespacing*{\section}{0mm}{0mm}{3mm}
\titlespacing*{\subsection}{0mm}{6mm}{0mm}
\titlespacing*{\subsubsection}{0mm}{3mm}{0mm}
\titlespacing*{\paragraph}{0mm}{3mm}{0mm}

\setcounter{secnumdepth}{1}

\titleformat{\chapter}
  [block]
  {\raggedright\sffamily\huge\color{Maroon}}
  {Chapter \thechapter ~~}
  {0em}
  {}
  []

\titleformat{\section}
  [block]
  {\clearpage\raggedright\rmfamily\LARGE\color{Maroon}}
  {\thesection ~~}
  {0em}
  {}
  []

% Case, statute, rule, etc. title
\titleformat{\subsection}
  [block]
  {\needspace{9\baselineskip}\raggedright\rmfamily\Large\color{Maroon}}
  {\thesubsection ~~}
  {0em}
  {}
  [\vspace{-1.3em}\textcolor{Maroon}{\rule{\textwidth}{.5pt}}]

% Case - Judge Name
\titleformat{\subsubsection}
  [block]
  {\needspace{3\baselineskip}\raggedright\rmfamily\large\bfseries}
  {\thesubsubsection ~~}
  {0em}
  {}
  []


\titleformat{\paragraph}
  [block]
  {\needspace{3\baselineskip}\raggedright\rmfamily\large\itshape}
  {\theparagraph}
  {0em}
  {}
  []

% Case, etc. first heading
\newcommand{\casesection}[1]{\needspace{3\baselineskip}\vspace{.5em}\begin{center}\rmfamily\large{\bfseries{#1}}\end{center}}
% Case, etc. second heading
\newcommand{\casesubsection}[1]{\needspace{3\baselineskip}\begin{center}\rmfamily\large{\itshape{#1}}\end{center}}
% Case, etc. third heading
\newcommand{\casesubsubsection}[1]{\needspace{3\baselineskip}\begin{center}\rmfamily\normalsize{#1}\end{center}}

% ===========
% = Figures =
% ===========

%\graphicspath{{../img/}}
\renewcommand*{\figureformat}{}
\renewcommand*{\captionformat}{}

% ============
% = Epigraph =
% ============

\newcommand{\openepigraph}[3]{ 
{\noindent{\color{Maroon}{\Large\faQuoteLeft}}\hspace{.5em}\rmfamily\normalsize
{\itshape{#1}}
\begin{flushright}\noindent{\color{Maroon}{\faPenNib}} ~{#2}, {\itshape{#3}} \end{flushright}}
}

% set margin and font for quote
%\renewenvironment{quote}{
%  \list{}{\leftmargin=3.5cm\topsep=0pt}
%  \item\relax\small\itshape
%}
%{\endlist}

% ===============
% = BLockquotes =
% ===============

\renewenvironment{quote}{
  \list{}{\leftmargin=2em\rightmargin=2em}
  \item\relax\small
}
{\endlist}

% =========
% = Dates =
% =========

\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

% =====================
% = Table of Contents =
% =====================

\newcommand{\blankpage}{\newpage\hbox{}\thispagestyle{empty}\newpage}
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\makeatletter
\@ifpackageloaded{sidenotes}{}{\usepackage{sidenotes}}
\@ifpackageloaded{marginnote}{}{\usepackage{marginnote}}
\makeatother

% ===================
% = Pandoc citeproc =
% ===================

% definitions for citeproc citations
\NewDocumentCommand\citeproctext{}{}
\NewDocumentCommand\citeproc{mm}{%
  \begingroup\def\citeproctext{#2}\cite{#1}\endgroup}
\makeatletter
 % allow citations to break across lines
 \let\@cite@ofmt\@firstofone
 % avoid brackets around text for \cite:
 \def\@biblabel#1{}
 \def\@cite#1#2{{#1\if@tempswa , #2\fi}}
\makeatother
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-indent, #2 entry-spacing
 {\begin{list}{}{%
  \setlength{\itemindent}{0pt}
  \setlength{\leftmargin}{0pt}
  \setlength{\parsep}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
   \setlength{\leftmargin}{\cslhangindent}
   \setlength{\itemindent}{-1\cslhangindent}
  \fi
  % set entry spacing
  \setlength{\itemsep}{#2\baselineskip}}}
 {\end{list}}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{\hfill\break\parbox[t]{\linewidth}{\strut\ignorespaces#1\strut}}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}

% ==============
% = Hyperlinks =
% ==============

\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{tt}
\hypersetup{
  pdftitle={Employment Law},
  pdfauthor={Eric M. Fink},
  colorlinks=true,
  linkcolor={HopkinsBlue},
  filecolor={Maroon},
  citecolor={HopkinsBlue},
  urlcolor={HopkinsBlue},
  pdfcreator={LaTeX via pandoc}}

% ==============================================================================
% =============================== BEGIN DOCUMENT ===============================
% ==============================================================================


\title{$title$}
\author{$author$}
\date{}
\begin{document}
\color{OffBlack}

% Cover 

{\includepdf{bookcover.pdf}\clearpage}{}

\blankpage

\frontmatter

% Frontispiece
\thispagestyle{empty}
\begin{figure}
\centering
\includegraphics[width=1\textwidth]{../img/frontispiece.jpg}
\caption{Hans Holbein the Younger,  \textit{$frontispiece$}. Print by Hans Lützelburger (ca. 1526)}
\end{figure}
\clearpage

% Title page

\thispagestyle{empty}
\begin{flushright}
\vspace*{50mm}

{\bfseries\Huge{$title$}} 

{\bfseries\vspace{5mm}}

{\Large{An Open-Source Casebook}} 

\vspace{20mm}

{\normalsize{Eric M. Fink}} 

\vspace*{\fill}

\begin{small}

\rmfamily{Elon Law School}  

\rmfamily{\textit{Greensboro, North Carolina}}  

\rmfamily{\monthyear} 

\end{small}

\end{flushright}

\clearpage

% License 

\thispagestyle{empty}
\begingroup
\parindent 0pt
\vspace*{\fill}

\ccbyncsa

\begin{small}
\raggedright{This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.} \\
\url{https://creativecommons.org/licenses/by-nc-sa/4.0/}

\vspace{1em}

Eric M. Fink\\
Associate Professor of Law \\
Elon University School of Law \\
Greensboro, North Carolina 27408 \\
\url{https://www.emfink.net/ElonLaw/}

\vspace{1em}

Source code: \url{https://github.com/EricMFink/$repo$}

\itshape{version $version$, \monthyear}

\end{small}
\endgroup

\clearpage

% Epigraph 

\thispagestyle{empty}

\topskip0pt
\vspace*{\fill}
\openepigraph{$epigraph$}{$epigraph-author$}{$epigraph-source$}
\vspace*{\fill}

% Preface 
\chapter*{Preface}

{$description$}

Most of the materials reproduced here are in the public domain; excerpts from copyrighted materials are included for teaching purposes under the fair use doctrine. Materials have been redacted to omit passages not pertinent to the learning objectives. Judicial opinions have also been "cleaned up" for ease of reading.\footnote{\textit{See} Jack Metzler, {\textit{Cleaning Up Quotations}}, 18 J. App. Prac. \& Process 143 (2017) (proposing "cleaned up" parenthetical for quotations from judicial opinions, to indicate the author “has removed extraneous, non-substantive material like brackets, quotation marks, ellipses, footnote reference numbers, and internal citations; may have changed capitalization without using brackets to indicate that change; and affirmatively represents that the alterations were made solely to enhance readability and that the quotation otherwise faithfully reproduces the quoted text.”)} 

\renewcommand*\contentsname{Contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{1}
\tableofcontents
}

\mainmatter

$body$

\backmatter

\pagestyle{plain.scrheadings}

\chapter*{Acknowledgements}

Many thanks to my students in \href{https://www.emfink.net/{$repo$}/}{{$title$} at Elon Law School} for their feedback on previous versions of this casebook and their patience with typographical errors \& formatting glitches. 

\chapter*{Colophon}

\raggedright{Set in \href{https://www.type-together.com/literata-font/}{Literata} and \href{https://www.type-together.com/adelle-sans-font/}{Adelle Sans} by \href{https://www.type-together.com/veronika-burian/}{Veronika Burian} and \href{https://www.type-together.com/jose-scaglione/}{José Scaglione}; \href{https://www.type-together.com/lft-etica-mono-font/}{LFT Etica Mono} by \href{https://www.type-together.com/leftloft/}{Leftloft}.}

\begin{figure}
\centering
\includegraphics[width=0.3\textwidth]{../img/gutenberg_press.png}
\end{figure}

\end{document}